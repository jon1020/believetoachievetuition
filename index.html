<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Book a Session ‚Äì Believe to Achieve Tuition</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --cream: #FAF7F2; --ink: #1A1814; --bark: #6B5B45;
    --gold: #C9963A; --sage: #7A9E7E; --blush: #E8DDD0;
    --white: #FFFFFF; --red: #c0392b;
  }
  body { font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--ink); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem 1rem; }
  .widget { width: 100%; max-width: 580px; background: var(--white); border-radius: 20px; overflow: hidden; box-shadow: 0 8px 60px rgba(26,24,20,0.12), 0 2px 12px rgba(26,24,20,0.06); }
  .widget-header { background: var(--ink); padding: 2rem 2.5rem; position: relative; overflow: hidden; }
  .widget-header::after { content: ''; position: absolute; top: -30px; right: -30px; width: 140px; height: 140px; background: var(--gold); border-radius: 50%; opacity: 0.15; }
  .widget-header h1 { font-family: 'DM Serif Display', serif; font-size: 1.8rem; color: var(--white); line-height: 1.2; position: relative; z-index: 1; }
  .widget-header p { color: var(--gold); font-size: 0.875rem; margin-top: 0.35rem; font-weight: 600; position: relative; z-index: 1; }
  .widget-body { padding: 2rem 2.5rem 2.5rem; }

  .steps { display: flex; gap: 0.5rem; margin-bottom: 2rem; align-items: center; }
  .step-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--blush); transition: all 0.3s; }
  .step-dot.active { background: var(--gold); width: 24px; border-radius: 4px; }
  .step-dot.done { background: var(--sage); }

  .section { display: none; }
  .section.active { display: block; animation: fadeIn 0.3s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

  .section-title { font-family: 'DM Serif Display', serif; font-size: 1.15rem; color: var(--ink); margin-bottom: 1.25rem; }
  .info-note { background: #f0f7f1; border: 1px solid #c3dfc7; border-radius: 10px; padding: 0.75rem 1rem; font-size: 0.82rem; color: #4a7a50; margin-bottom: 1.1rem; line-height: 1.5; }

  .child-card { border: 1.5px solid var(--blush); border-radius: 14px; padding: 1rem 1.1rem; margin-bottom: 0.75rem; animation: fadeIn 0.25s ease; }
  .child-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
  .child-tag { font-size: 0.72rem; font-weight: 700; color: var(--bark); text-transform: uppercase; letter-spacing: 0.06em; }
  .child-name-display { font-size: 0.95rem; font-weight: 600; color: var(--ink); margin-top: 0.1rem; }
  .child-session-row { display: flex; justify-content: space-between; align-items: center; }
  .s-label { font-size: 0.85rem; color: var(--bark); }
  .s-time { font-size: 0.78rem; color: var(--bark); opacity: 0.7; margin-top: 0.15rem; }
  .s-price { font-size: 0.9rem; font-weight: 700; text-align: right; }
  .remove-child-btn { background: none; border: none; cursor: pointer; color: var(--bark); font-size: 0.78rem; opacity: 0.5; transition: opacity 0.2s, color 0.2s; display: flex; align-items: center; gap: 0.25rem; padding: 0; }
  .remove-child-btn:hover { opacity: 1; color: var(--red); }

  .adding-form { border: 1.5px solid var(--gold); border-radius: 14px; padding: 1.1rem; margin-bottom: 0.75rem; background: #FEFCF8; }
  .adding-form-title { font-size: 0.75rem; font-weight: 700; color: var(--gold); text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 0.9rem; }
  .name-field label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--bark); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.4rem; }
  .name-field input { width: 100%; padding: 0.75rem 1rem; border: 1.5px solid var(--blush); border-radius: 10px; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; color: var(--ink); background: var(--white); outline: none; transition: border-color 0.2s; }
  .name-field input:focus { border-color: var(--gold); }
  .name-field input.error { border-color: var(--red); }

  .form-label { font-size: 0.75rem; font-weight: 600; color: var(--bark); text-transform: uppercase; letter-spacing: 0.05em; margin: 0.9rem 0 0.5rem; display: block; }
  .session-opts { display: grid; gap: 0.55rem; }
  .session-opt { border: 1.5px solid var(--blush); border-radius: 11px; padding: 0.8rem 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: border-color 0.15s, background 0.15s; background: var(--white); }
  .session-opt:hover { border-color: var(--bark); background: var(--cream); }
  .session-opt.selected { border-color: var(--gold); background: #FDF8F0; }
  .opt-label { font-size: 0.875rem; font-weight: 600; color: var(--ink); }
  .opt-sub { font-size: 0.75rem; color: var(--bark); margin-top: 0.1rem; }
  .opt-price { font-size: 0.95rem; font-weight: 700; color: var(--ink); flex-shrink: 0; margin-left: 0.75rem; }
  .session-opt.selected .opt-price::before { content: '‚úì '; color: var(--gold); }

  .time-slot-wrap { display: none; margin-top: 0.9rem; }
  .time-slot-wrap.visible { display: block; background: #FEFCF8; border: 1.5px solid var(--gold); border-radius: 12px; padding: 0.85rem 1rem; }
  .time-slot-wrap.visible .form-label { color: var(--gold); font-weight: 800; }
  .ts-btn { padding: 0.55rem 1.25rem; border-radius: 9px; border: 2px solid var(--gold); background: var(--white); font-family: 'DM Sans', sans-serif; font-size: 0.875rem; font-weight: 600; color: var(--ink); cursor: pointer; transition: all 0.2s cubic-bezier(0.34,1.56,0.64,1); }
  .ts-btn { padding: 0.55rem 1.25rem; border-radius: 9px; border: 1.5px solid var(--blush); background: var(--white); font-family: 'DM Sans', sans-serif; font-size: 0.875rem; font-weight: 500; color: var(--ink); cursor: pointer; transition: all 0.15s; }
  .ts-btn:hover:not(:disabled) { background: var(--gold); color: var(--white); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(201,150,58,0.3); }
  .ts-btn.selected { background: var(--gold); border-color: var(--gold); color: var(--white); font-weight: 700; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(201,150,58,0.3); }
  .ts-btn:disabled { background: var(--blush); border-color: var(--blush); color: #aaa; cursor: not-allowed; text-decoration: line-through; opacity: 0.7; }

  .form-btns { display: flex; gap: 0.5rem; margin-top: 0.9rem; }
  .btn-confirm { flex: 1; padding: 0.7rem; border-radius: 10px; background: var(--ink); color: var(--white); border: 2px solid var(--ink); font-family: 'DM Sans', sans-serif; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
  .btn-confirm:hover { background: var(--white); color: var(--ink); border-color: var(--ink); }
  .btn-cancel { padding: 0.7rem 1rem; border-radius: 10px; background: none; border: 1.5px solid var(--blush); color: var(--bark); font-family: 'DM Sans', sans-serif; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: border-color 0.2s; }
  .btn-cancel:hover { border-color: var(--bark); }

  .add-child-btn { width: 100%; background: none; border: 1.5px dashed var(--blush); border-radius: 10px; color: var(--bark); font-family: 'DM Sans', sans-serif; font-size: 0.875rem; font-weight: 500; padding: 0.7rem 1rem; cursor: pointer; transition: border-color 0.2s, color 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.4rem; margin-bottom: 1rem; }
  .add-child-btn:hover { border-color: var(--gold); color: var(--ink); }
  .add-child-btn .plus { font-size: 1.2rem; line-height: 1; }

  .sibling-locked { display: flex; align-items: center; gap: 0.6rem; background: var(--blush); border-radius: 10px; padding: 0.75rem 1rem; font-size: 0.8rem; color: var(--bark); opacity: 0.7; margin-bottom: 1rem; }
  .sibling-active { background: #f0f7f1; border: 1px solid #c3dfc7; border-radius: 10px; padding: 0.75rem 1rem; font-size: 0.82rem; color: #4a7a50; margin-bottom: 1rem; }

  .cal-section { margin-top: 0.25rem; }
  .cal-label { font-size: 0.8rem; font-weight: 600; color: var(--bark); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.65rem; }
  .cal-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
  .cal-nav-btn { background: none; border: 1.5px solid var(--blush); border-radius: 8px; width: 32px; height: 32px; cursor: pointer; font-size: 1rem; color: var(--bark); display: flex; align-items: center; justify-content: center; transition: border-color 0.2s; }
  .cal-nav-btn:hover { border-color: var(--gold); color: var(--ink); }
  .cal-month { font-size: 0.9rem; font-weight: 600; color: var(--ink); }
  .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
  .cal-head { font-size: 0.7rem; color: var(--bark); font-weight: 600; padding: 0.3rem 0; }
  .cal-day { aspect-ratio: 1; border-radius: 8px; border: none; background: none; font-size: 0.82rem; cursor: default; font-family: 'DM Sans', sans-serif; color: #ccc; display: flex; align-items: center; justify-content: center; position: relative; flex-direction: column; gap: 1px; }
  .cal-day.avail { background: #FDF8F0; color: var(--ink); cursor: pointer; font-weight: 500; }
  .cal-day.avail::after { content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; border-radius: 50%; background: var(--sage); }
  .cal-day.avail:hover { background: #f5eddc; outline: 1.5px solid var(--sage); }
  .cal-day.partial { background: #FDF8F0; color: var(--ink); cursor: pointer; font-weight: 500; }
  .cal-day.partial::after { content: ''; position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; border-radius: 50%; background: var(--gold); }
  .cal-day.partial:hover { background: #f5eddc; outline: 1.5px solid var(--gold); }
  .cal-day.picked { background: var(--gold) !important; color: var(--white) !important; font-weight: 700; outline: none !important; }
  .cal-day.picked::after { background: rgba(255,255,255,0.6) !important; }
  .cal-day.full { background: var(--blush); color: #bbb; }
  .cal-day.today { outline: 2px solid var(--bark); outline-offset: -2px; }
  .date-pill { display: none; align-items: center; justify-content: space-between; background: #FDF8F0; border: 1.5px solid var(--gold); border-radius: 10px; padding: 0.65rem 1rem; margin-top: 0.75rem; }
  .date-pill.show { display: flex; }
  .dp-date { font-size: 0.875rem; font-weight: 600; color: var(--ink); }
  .dp-time { font-size: 0.78rem; color: var(--bark); margin-top: 0.1rem; }
  .dp-clear { background: none; border: none; cursor: pointer; color: var(--bark); font-size: 0.78rem; opacity: 0.6; transition: opacity 0.2s; }
  .dp-clear:hover { opacity: 1; }

  .tc-wrap { display: flex; align-items: flex-start; gap: 0.75rem; background: var(--cream); border-radius: 10px; padding: 0.9rem 1rem; margin-bottom: 1rem; }
  .tc-wrap input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--gold); cursor: pointer; flex-shrink: 0; margin-top: 2px; }
  .tc-wrap label { font-size: 0.82rem; color: var(--bark); line-height: 1.5; cursor: pointer; }
  .tc-wrap a { color: var(--gold); text-decoration: underline; }

  .total-row { display: flex; justify-content: space-between; align-items: center; padding: 0.85rem 0 0; border-top: 1.5px solid var(--blush); margin-top: 0.75rem; }
  .total-label { font-size: 0.95rem; font-weight: 600; color: var(--ink); }
  .total-right { text-align: right; }
  .total-amount { font-size: 1.2rem; font-weight: 700; color: var(--ink); }
  .saving-note { font-size: 0.75rem; color: var(--sage); font-weight: 500; margin-top: 0.1rem; }

  .field { margin-bottom: 1rem; }
  .field label { display: block; font-size: 0.8rem; font-weight: 500; color: var(--bark); margin-bottom: 0.4rem; text-transform: uppercase; letter-spacing: 0.05em; }
  .field input { width: 100%; padding: 0.8rem 1rem; border: 1.5px solid var(--blush); border-radius: 10px; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; color: var(--ink); background: var(--white); transition: border-color 0.2s; outline: none; }
  .field input:focus { border-color: var(--gold); }
  .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }

  .booking-summary { background: var(--cream); border-radius: 12px; padding: 1.1rem; margin-bottom: 1.25rem; }
  .bs-row { display: flex; justify-content: space-between; font-size: 0.875rem; padding: 0.3rem 0; color: var(--bark); }
  .bs-row.total { border-top: 1px solid var(--blush); margin-top: 0.5rem; padding-top: 0.75rem; font-weight: 600; color: var(--ink); font-size: 1rem; }
  .bs-row.disc { color: var(--sage); font-weight: 500; }
  .bs-div { border: none; border-top: 1px dashed var(--blush); margin: 0.4rem 0; }

  .btn { width: 100%; padding: 0.95rem; border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; outline: none; }
  .btn-primary { background: var(--ink); color: var(--white); }
  .btn-primary:hover:not(:disabled) { background: #2d2b27; transform: translateY(-1px); }
  .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none !important; }
  .btn-back { background: none; color: var(--bark); font-size: 0.85rem; font-weight: 400; width: auto; padding: 0.5rem 0; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.4rem; cursor: pointer; border: none; }
  .btn-back:hover { color: var(--ink); }
  .mt1 { margin-top: 1rem; }

  .sending-state { text-align: center; padding: 2rem 0; }
  .spinner { width: 40px; height: 40px; border: 3px solid var(--blush); border-top-color: var(--gold); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .sending-state p { color: var(--bark); font-size: 0.9rem; }

  .success-state { text-align: center; padding: 1rem 0; }
  .success-icon { width: 64px; height: 64px; background: var(--sage); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.25rem; font-size: 1.75rem; }
  .success-state h2 { font-family: 'DM Serif Display', serif; font-size: 1.5rem; margin-bottom: 0.5rem; }
  .success-state p { color: var(--bark); font-size: 0.9rem; line-height: 1.6; }
  .success-details { background: var(--cream); border-radius: 12px; padding: 1.1rem; margin: 1.25rem 0; text-align: left; }
  .badge { display: inline-block; background: var(--blush); color: var(--bark); font-size: 0.72rem; font-weight: 500; padding: 0.2rem 0.6rem; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 1rem; }
  .error-note { background: #fdf0f0; border: 1px solid #f5c6c6; border-radius: 10px; padding: 0.75rem 1rem; font-size: 0.82rem; color: var(--red); margin-top: 0.75rem; display: none; }

  .cal-legend { display: flex; gap: 1rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
  .legend-item { display: flex; align-items: center; gap: 0.35rem; font-size: 0.75rem; color: var(--bark); }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .legend-dot.gold { background: var(--gold); }
  .legend-dot.sage { background: var(--sage); }
  .legend-dot.blush { background: var(--blush); }
</style>
</head>
<body>
<div class="widget">
  <div class="widget-header">
    <h1>Book a Session</h1>
    <p>Believe to Achieve Tuition ¬∑ Sundays ¬∑ Small group ¬∑ In-person</p>
  </div>
  <div class="widget-body">
    <div class="steps">
      <div class="step-dot active" id="dot-1"></div>
      <div class="step-dot" id="dot-2"></div>
      <div class="step-dot" id="dot-3"></div>
    </div>

    <!-- STEP 1 -->
    <div class="section active" id="step-1">
      <div class="section-title">Who are you booking for?</div>
      <div class="info-note">üìÖ All sessions run on <strong>Sundays</strong>, in-person as small groups. 1-hour sessions are 9‚Äì10am or 10‚Äì11am; 2-hour sessions run the full 9‚Äì11am.</div>
      <div id="children-list"></div>
      <div class="adding-form" id="adding-form">
        <div class="adding-form-title" id="adding-form-title">Child 1</div>
        <div class="name-field">
          <label>Child's name</label>
          <input type="text" id="adding-name" placeholder="e.g. Lily" />
        </div>
        <span class="form-label">Choose a session</span>
        <div class="session-opts" id="session-opts"></div>
        <div class="time-slot-wrap" id="time-slot-wrap">
          <span class="form-label">Choose a time slot</span>
          <div class="time-slots" id="time-slots"></div>
        </div>
        <div class="form-btns">
          <button class="btn-cancel" type="button" id="cancel-btn" onclick="cancelChild()" style="display:none;">Cancel</button>
          <button class="btn-confirm" type="button" onclick="confirmChild()">Add Child ‚úì</button>
        </div>
      </div>
      <div id="add-more-wrap" style="display:none;">
        <button class="add-child-btn" type="button" onclick="openFormForNext()">
          <span class="plus">+</span> Add another child
        </button>
      </div>
      <div id="sibling-locked" class="sibling-locked" style="display:none;">üîí Add a second child to unlock the sibling discount</div>
      <div id="sibling-active" class="sibling-active" style="display:none;">üéâ <strong>Sibling discount applied!</strong> Each child is charged ¬£27/hr instead of the standard rate.</div>
      <div class="cal-section" id="cal-section" style="display:none;">
        <div class="info-note">üìÖ The Sunday you choose applies to <strong>all children</strong> in this booking.</div>
        <div class="cal-label">Pick a Sunday</div>
        <div class="cal-legend">
          <div class="legend-item"><div class="legend-dot sage"></div> All slots available</div>
          <div class="legend-item"><div class="legend-dot gold"></div> Partially available</div>
          <div class="legend-item"><div class="legend-dot blush"></div> Fully booked</div>
        </div>
        <div class="cal-nav">
          <button class="cal-nav-btn" type="button" onclick="changeMonth(-1)">&#8249;</button>
          <span class="cal-month" id="cal-month"></span>
          <button class="cal-nav-btn" type="button" onclick="changeMonth(1)">&#8250;</button>
        </div>
        <div class="cal-grid" id="cal-grid"></div>
        <div class="date-pill" id="date-pill">
          <div>
            <div class="dp-date" id="dp-date"></div>
            <div class="dp-time">Small group ¬∑ In-person</div>
          </div>
          <button class="dp-clear" type="button" onclick="clearDate()">‚úï Change</button>
        </div>
      </div>
      <div id="total-section" style="display:none;">
        <div class="total-row">
          <span class="total-label">Total</span>
          <div class="total-right">
            <div class="total-amount" id="total-amt">¬£0</div>
            <div class="saving-note" id="saving-note" style="display:none;"></div>
          </div>
        </div>
      </div>
      <div class="mt1">
        <button class="btn btn-primary" id="proceed-btn" onclick="goTo(2)" disabled>Continue to Your Details</button>
      </div>
    </div>

    <!-- STEP 2 -->
    <div class="section" id="step-2">
      <button class="btn btn-back" onclick="goTo(1)">‚Üê Back</button>
      <div class="section-title">Your details</div>
      <div class="booking-summary" id="booking-summary"></div>
      <div class="field-row">
        <div class="field"><label>First Name</label><input type="text" id="first-name" placeholder="Jane" /></div>
        <div class="field"><label>Last Name</label><input type="text" id="last-name" placeholder="Smith" /></div>
      </div>
      <div class="field"><label>Email Address</label><input type="email" id="email" placeholder="jane@example.com" /></div>
      <div class="field"><label>Phone Number</label><input type="tel" id="phone" placeholder="07700 900000" /></div>
      <div class="tc-wrap">
        <input type="checkbox" id="tc-checkbox" />
        <label for="tc-checkbox">I have read and agree to the <a href="https://drive.google.com/file/d/1mY-IwfBuHAZkx5xAL9B5h941SI6M-eZu/preview" target="_blank">Terms and Conditions</a> of Believe to Achieve Tuition.</label>
      </div>
      <button class="btn btn-primary" onclick="submitBooking()">Confirm Booking & Send Details</button>
      <div class="error-note" id="error-note"></div>
    </div>

    <!-- SENDING -->
    <div class="section" id="step-sending">
      <div class="sending-state">
        <div class="spinner"></div>
        <p>Sending your booking confirmation...</p>
      </div>
    </div>

    <!-- SUCCESS -->
    <div class="section" id="step-success">
      <div class="success-state">
        <div class="success-icon">‚úì</div>
        <div class="badge">Booking Received</div>
        <h2>You're all booked!</h2>
        <p>A confirmation email has been sent to you with payment details. Please make your bank transfer to secure your place.</p>
        <div class="success-details" id="success-details"></div>
        <p style="font-size:0.82rem;color:var(--bark);margin-top:0.75rem;">Can't find the email? Check your spam folder or contact <strong>believetoachievetuition@gmail.com</strong></p>
      </div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ‚úèÔ∏è  AVAILABILITY ‚Äî UPDATE EACH WEEK
//
//  Three options for each Sunday:
//
//  Both slots available (gold dot on calendar):
//    "2026-03-01": true,
//
//  Fully booked (greyed out on calendar):
//    "2026-03-08": false,
//
//  Partially available (green dot on calendar):
//    "2026-03-15": { "9:00": false, "10:00": true },
//    "2026-03-22": { "9:00": true,  "10:00": false },
//
//  Note: for a partial Sunday, 2-hour sessions (9‚Äì11am) are
//  only available if BOTH slots are open.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AVAILABILITY = {
  "2026-03-01": true,
  "2026-03-08": true,
  "2026-03-15": { "9:00": false, "10:00": true },
  "2026-03-22": true,
  "2026-03-29": true,
  "2026-04-05": true,
  "2026-04-12": false,
  "2026-04-19": true,
  "2026-04-26": true,
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const EMAILJS_PUBLIC_KEY  = 'YcHluYUj5pINA5zCe';
const EMAILJS_SERVICE_ID  = 'service_j11tywx';
const EMAILJS_TEMPLATE_ID = 'template_lom6kel';
const TC_LINK = 'https://drive.google.com/file/d/1mY-IwfBuHAZkx5xAL9B5h941SI6M-eZu/preview';
const SIBLING_RATE = 27;
const MONTHS = ['January','February','March','April','May','June','July','August','September','October','November','December'];

const SESSIONS = [
  { value: '1hr-maths',    label: '1 Hour Maths',            price: 30, hours: 1, sub: '9‚Äì10am or 10‚Äì11am' },
  { value: '1hr-literacy', label: '1 Hour Literacy',          price: 30, hours: 1, sub: '9‚Äì10am or 10‚Äì11am' },
  { value: '2hr-both',     label: '2 Hours Maths & Literacy', price: 60, hours: 2, sub: 'Full session ¬∑ 9‚Äì11am' },
];

let children      = [];
let nextId        = 1;
let addingSession = null;
let addingTime    = null;
let formOpen      = false;
let selectedDate  = null;
let calYear, calMonth;

// ‚îÄ‚îÄ Helper: check if a date has any available slots ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function dateStatus(ds) {
  const av = AVAILABILITY[ds];
  if (av === undefined) return 'hidden';
  if (av === false) return 'full';
  if (av === true)  return 'avail';
  // It's an object ‚Äî check if any slot is true
  const anyOpen = Object.values(av).some(v => v === true);
  return anyOpen ? 'partial' : 'full';
}

// ‚îÄ‚îÄ Helper: is a specific slot available on a date? ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function slotAvailable(ds, slot) {
  const av = AVAILABILITY[ds];
  if (av === true)  return true;
  if (av === false) return false;
  if (typeof av === 'object') return av[slot] === true;
  return false;
}

window.addEventListener('load', () => {
  const now = new Date();
  calYear  = now.getFullYear();
  calMonth = now.getMonth();
  emailjs.init(EMAILJS_PUBLIC_KEY);
  renderSessionOpts();
  renderCalendar();
  document.getElementById('adding-form-title').textContent = 'Child 1';
  document.getElementById('cancel-btn').style.display = 'none';
  formOpen = true;
});

// ‚îÄ‚îÄ Build session options via JS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSessionOpts() {
  const container = document.getElementById('session-opts');
  container.innerHTML = '';
  SESSIONS.forEach(s => {
    const el = document.createElement('div');
    el.className = 'session-opt';
    el.innerHTML = `<div><div class="opt-label">${s.label}</div><div class="opt-sub">${s.sub}</div></div><div class="opt-price">¬£${s.price}</div>`;
    el.addEventListener('click', () => pickSession(s.value));
    container.appendChild(el);
  });
}

// ‚îÄ‚îÄ Build time slot buttons, respecting availability ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTimeSlotBtns(ds) {
  const container = document.getElementById('time-slots');
  container.innerHTML = '';
  [{ slot: '9:00', label: '9‚Äì10am' }, { slot: '10:00', label: '10‚Äì11am' }].forEach(t => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'ts-btn';
    btn.textContent = t.label;
    // Grey out if slot is full on the selected date
    const isFull = ds && !slotAvailable(ds, t.slot);
    if (isFull) {
      btn.disabled = true;
      btn.title = 'This slot is fully booked';
    } else {
      btn.addEventListener('click', () => pickTimeSlot(t.slot, btn));
    }
    container.appendChild(btn);
  });
}

// ‚îÄ‚îÄ Session selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pickSession(value) {
  addingSession = SESSIONS.find(s => s.value === value);
  addingTime = null;
  document.querySelectorAll('.session-opt').forEach(el => {
    el.classList.toggle('selected', el.querySelector('.opt-label').textContent === addingSession.label);
  });
  // Reset any previously selected time button
  document.querySelectorAll('.ts-btn').forEach(b => b.classList.remove('selected'));

  const tsWrap = document.getElementById('time-slot-wrap');
  if (addingSession.hours === 1) {
    // Re-render time slots so availability is fresh for selected date
    renderTimeSlotBtns(selectedDate);
    tsWrap.classList.add('visible');
  } else {
    // 2-hour session ‚Äî only available if both slots are open
    tsWrap.classList.remove('visible');
    if (selectedDate && !slotAvailable(selectedDate, '9:00')) {
      // 9am is full so 2-hour is not possible ‚Äî warn and deselect
      document.querySelectorAll('.session-opt').forEach(el => el.classList.remove('selected'));
      addingSession = null;
      alert('Sorry, the 2-hour session (9‚Äì11am) is not available on this Sunday as the 9‚Äì10am slot is fully booked.');
    } else {
      addingTime = '9:00';
    }
  }
}

// ‚îÄ‚îÄ Time slot selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pickTimeSlot(slot, btn) {
  addingTime = slot;
  document.querySelectorAll('.ts-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
}

// ‚îÄ‚îÄ Confirm child ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function confirmChild() {
  const nameEl = document.getElementById('adding-name');
  const name = nameEl.value.trim();
  if (!name) { nameEl.classList.add('error'); nameEl.focus(); return; }
  nameEl.classList.remove('error');
  if (!addingSession) { alert('Please select a session for this child.'); return; }
  if (!addingTime)    { alert('Please choose a time slot for this child.'); return; }
  const timeLabel = addingSession.hours === 2 ? '9‚Äì11am' : addingTime === '9:00' ? '9‚Äì10am' : '10‚Äì11am';
  children.push({ id: nextId++, name, ...addingSession, time: addingTime, timeLabel });
  formOpen = false; addingSession = null; addingTime = null;
  resetForm(); renderAll();
}

// ‚îÄ‚îÄ Cancel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function cancelChild() {
  formOpen = false; addingSession = null; addingTime = null;
  resetForm(); renderAll();
}

function resetForm() {
  document.getElementById('adding-name').value = '';
  document.getElementById('adding-name').classList.remove('error');
  document.querySelectorAll('.session-opt').forEach(o => o.classList.remove('selected'));
  document.getElementById('time-slot-wrap').classList.remove('visible');
  document.getElementById('adding-form').style.display = 'none';
}

// ‚îÄ‚îÄ Open form for next child ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openFormForNext() {
  formOpen = true; addingSession = null; addingTime = null;
  document.getElementById('adding-form-title').textContent = 'Child ' + (children.length + 1);
  document.getElementById('adding-name').value = '';
  document.getElementById('adding-name').classList.remove('error');
  document.querySelectorAll('.session-opt').forEach(o => o.classList.remove('selected'));
  document.getElementById('time-slot-wrap').classList.remove('visible');
  document.getElementById('adding-form').style.display = 'block';
  document.getElementById('add-more-wrap').style.display = 'none';
  document.getElementById('cancel-btn').style.display = 'block';
  document.getElementById('adding-name').focus();
}

// ‚îÄ‚îÄ Remove child ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function removeChild(id) {
  children = children.filter(c => c.id !== id); renderAll();
}

// ‚îÄ‚îÄ Render all ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAll() {
  const count = children.length;
  const hasSibling = count >= 2;
  document.getElementById('children-list').innerHTML = children.map((c, i) => {
    const dp = hasSibling ? Math.round(SIBLING_RATE * c.hours) : c.price;
    const priceHTML = hasSibling
      ? `<span style="text-decoration:line-through;opacity:0.35;font-size:0.8rem;margin-right:0.3rem;">¬£${c.price}</span><span style="color:var(--sage);font-weight:700;">¬£${dp}</span>`
      : `<span style="color:var(--ink);">¬£${c.price}</span>`;
    return `<div class="child-card">
      <div class="child-card-header">
        <div><div class="child-tag">Child ${i+1}</div><div class="child-name-display">${c.name}</div></div>
        <button class="remove-child-btn" type="button" onclick="removeChild(${c.id})">‚úï Remove</button>
      </div>
      <div class="child-session-row">
        <div><div class="s-label">${c.label}</div><div class="s-time">${c.timeLabel}</div></div>
        <div class="s-price">${priceHTML}</div>
      </div>
    </div>`;
  }).join('');

  document.getElementById('add-more-wrap').style.display  = (count > 0 && count < 5 && !formOpen) ? 'block' : 'none';
  document.getElementById('sibling-locked').style.display = (count === 1 && !formOpen) ? 'flex'  : 'none';
  document.getElementById('sibling-active').style.display = (hasSibling && !formOpen)  ? 'block' : 'none';
  document.getElementById('cal-section').style.display    = (count > 0 && !formOpen)   ? 'block' : 'none';
  renderTotal(); renderProceedBtn();
}

function calcTotal() {
  const hasSibling = children.length >= 2;
  return children.reduce((s, c) => s + (hasSibling ? Math.round(SIBLING_RATE * c.hours) : c.price), 0);
}

function renderTotal() {
  const count = children.length;
  const hasSibling = count >= 2;
  const total    = calcTotal();
  const standard = children.reduce((s, c) => s + c.price, 0);
  document.getElementById('total-section').style.display = (count > 0 && !formOpen) ? 'block' : 'none';
  document.getElementById('total-amt').textContent = '¬£' + total;
  const sn = document.getElementById('saving-note');
  if (hasSibling && total < standard) { sn.style.display = 'block'; sn.textContent = 'Saving ¬£' + (standard - total) + ' with sibling discount'; }
  else sn.style.display = 'none';
}

function renderProceedBtn() {
  document.getElementById('proceed-btn').disabled = !(children.length > 0 && selectedDate && !formOpen);
}

// ‚îÄ‚îÄ Calendar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCalendar() {
  document.getElementById('cal-month').textContent = MONTHS[calMonth] + ' ' + calYear;
  const grid = document.getElementById('cal-grid');
  grid.innerHTML = '';
  ['Su','Mo','Tu','We','Th','Fr','Sa'].forEach(d => {
    const h = document.createElement('div'); h.className = 'cal-head'; h.textContent = d; grid.appendChild(h);
  });
  const firstDay    = new Date(calYear, calMonth, 1).getDay();
  const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
  const today = new Date(); today.setHours(0,0,0,0);
  for (let i = 0; i < firstDay; i++) {
    const e = document.createElement('div'); e.className = 'cal-day'; grid.appendChild(e);
  }
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(calYear, calMonth, d);
    const ds = toDS(date);
    const el = document.createElement('button');
    el.type = 'button'; el.className = 'cal-day'; el.textContent = d;
    if (date.getDay() === 0 && date >= today) {
      const status = dateStatus(ds);
      if (status === 'avail') {
        el.classList.add('avail');
        if (selectedDate === ds) el.classList.add('picked');
        el.addEventListener('click', () => pickDate(ds, date));
      } else if (status === 'partial') {
        el.classList.add('partial');
        if (selectedDate === ds) el.classList.add('picked');
        el.addEventListener('click', () => pickDate(ds, date));
      } else if (status === 'full') {
        el.classList.add('full'); el.title = 'Fully booked';
      }
      // 'hidden' = not in AVAILABILITY at all, leave as plain grey
    }
    if (ds === toDS(today)) el.classList.add('today');
    grid.appendChild(el);
  }
}

function pickDate(ds, date) {
  selectedDate = ds;
  document.getElementById('dp-date').textContent = date.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
  document.getElementById('date-pill').classList.add('show');
  // If a session is already selected and it's a 1-hour type, refresh time slots for new date
  if (addingSession && addingSession.hours === 1) {
    renderTimeSlotBtns(ds);
    document.getElementById('time-slot-wrap').classList.add('visible');
    addingTime = null;
  }
  renderCalendar(); renderProceedBtn();
}

function clearDate() {
  selectedDate = null;
  addingTime = null;
  document.getElementById('date-pill').classList.remove('show');
  if (addingSession && addingSession.hours === 1) {
    renderTimeSlotBtns(null);
    document.querySelectorAll('.ts-btn').forEach(b => b.classList.remove('selected'));
  }
  renderCalendar(); renderProceedBtn();
}

function changeMonth(dir) {
  calMonth += dir;
  if (calMonth > 11) { calMonth = 0; calYear++; }
  if (calMonth < 0)  { calMonth = 11; calYear--; }
  renderCalendar();
}

function toDS(date) {
  return date.getFullYear() + '-' + String(date.getMonth()+1).padStart(2,'0') + '-' + String(date.getDate()).padStart(2,'0');
}

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function goTo(step) {
  if (step === 2) buildBookingSummary();
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById('step-' + step).classList.add('active');
  for (let i = 1; i <= 3; i++) {
    const dot = document.getElementById('dot-' + i);
    if (dot) dot.className = 'step-dot' + (i < step ? ' done' : i === step ? ' active' : '');
  }
}

function buildBookingSummary() {
  const hasSibling = children.length >= 2;
  const d = new Date(selectedDate + 'T00:00:00');
  const dateLabel = d.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
  let html = '';
  children.forEach((c, i) => {
    if (i > 0) html += '<hr class="bs-div">';
    const dp = hasSibling ? Math.round(SIBLING_RATE * c.hours) : c.price;
    html += `<div class="bs-row"><span style="font-weight:600;">${c.name}</span><span>${c.label}</span></div>`;
    html += `<div class="bs-row"><span style="padding-left:0.5rem;opacity:0.6">Time</span><span>${c.timeLabel}</span></div>`;
    if (hasSibling) {
      html += `<div class="bs-row"><span style="padding-left:0.5rem;opacity:0.45">Standard</span><span style="text-decoration:line-through;opacity:0.45">¬£${c.price}</span></div>`;
      html += `<div class="bs-row disc"><span style="padding-left:0.5rem">Sibling rate</span><span>¬£${dp}</span></div>`;
    } else {
      html += `<div class="bs-row"><span style="padding-left:0.5rem">Price</span><span>¬£${c.price}</span></div>`;
    }
  });
  html += `<div class="bs-row" style="margin-top:0.5rem;"><span>Date</span><span>${dateLabel}</span></div>`;
  html += `<div class="bs-row total"><span>Total due</span><span>¬£${calcTotal()}</span></div>`;
  document.getElementById('booking-summary').innerHTML = html;
}

// ‚îÄ‚îÄ Submit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function submitBooking() {
  const first = document.getElementById('first-name').value.trim();
  const last  = document.getElementById('last-name').value.trim();
  const email = document.getElementById('email').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const tcOk  = document.getElementById('tc-checkbox').checked;
  const errEl = document.getElementById('error-note');
  errEl.style.display = 'none';
  if (!first || !last || !email || !phone) { errEl.textContent = 'Please fill in all fields.'; errEl.style.display = 'block'; return; }
  if (!tcOk) { errEl.textContent = 'Please read and agree to the Terms and Conditions to continue.'; errEl.style.display = 'block'; return; }

  const hasSibling = children.length >= 2;
  const total = calcTotal();
  const d = new Date(selectedDate + 'T00:00:00');
  const dateLabel = d.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
  const bookingSummaryText = children.map((c, i) => {
    const dp = hasSibling ? Math.round(SIBLING_RATE * c.hours) : c.price;
    return `Child ${i+1}: ${c.name}\nSession: ${c.label} (${c.timeLabel})\nPrice: ¬£${dp}${hasSibling ? ' (sibling rate)' : ''}`;
  }).join('\n\n') + `\n\nDate: ${dateLabel}\nTotal: ¬£${total}`;
  const payRef = (first[0] + last).replace(/\s/g,'').toUpperCase() + '-' + selectedDate.replace(/-/g,'');

  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById('step-sending').classList.add('active');

  try {
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
      parent_name: first + ' ' + last, parent_email: email,
      booking_summary: bookingSummaryText, total, payment_ref: payRef, tc_link: TC_LINK
    });
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
      parent_name: 'NEW BOOKING ‚Äî ' + first + ' ' + last,
      parent_email: 'believetoachievetuition@gmail.com',
      booking_summary: bookingSummaryText + '\n\nPhone: ' + phone + '\nEmail: ' + email,
      total, payment_ref: payRef, tc_link: TC_LINK
    });
    showSuccess(dateLabel, total, payRef);
  } catch(err) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById('step-2').classList.add('active');
    errEl.textContent = 'Sorry, there was a problem sending your confirmation. Please try again or contact believetoachievetuition@gmail.com directly.';
    errEl.style.display = 'block';
  }
}

function showSuccess(dateLabel, total, payRef) {
  const hasSibling = children.length >= 2;
  let html = '';
  children.forEach(c => {
    html += `<div class="bs-row"><span style="font-weight:600;">${c.name}</span><span>${c.label} ¬∑ ${c.timeLabel}</span></div>`;
  });
  if (hasSibling) html += `<div class="bs-row disc"><span>Sibling discount applied</span></div>`;
  html += `<div class="bs-row"><span>Date</span><span>${dateLabel}</span></div>`;
  html += `<div class="bs-row total"><span>Amount due</span><span>¬£${total}</span></div>`;
  html += `<div style="background:#f0f7f1;border-radius:8px;padding:0.6rem 0.85rem;margin-top:0.75rem;">
    <div style="font-size:0.72rem;font-weight:700;color:#4a7a50;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.2rem;">Payment Reference</div>
    <div style="font-weight:700;color:var(--ink);font-size:1rem;letter-spacing:0.05em;">${payRef}</div>
  </div>`;
  document.getElementById('success-details').innerHTML = html;
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById('step-success').classList.add('active');
  document.querySelectorAll('.step-dot').forEach(d => d.className = 'step-dot done');
}
</script>
</body>
</html>
